---
title: "TD VI: Inteligencia Artificial - Trabajo práctico 1 (2024 2do semestre)"
author: "Luca Mazzarello y Camila Migdal"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("rpart")
#install.packages("writexl")
#install.packages("dplyr")
#install.packages("ggplot2")
#install.packages("rpart.plot")
#install.packages("caret")
#install.packages("pROC")
library(rpart)
library(writexl)
library(dplyr)
library(ggplot2)
library(rpart.plot)
library(caret)
library(pROC)
```

## Objetivo

El objetivo de este trabajo práctico es que realicen un análisis completo utilizando árboles de decisión en R. El trabajo se presentará en formato R Markdown, integrando código, resultados y explicaciones en un único documento.

Hemos elegido R como lenguaje de programación para este TP por una razón fundamental: queremos que adquieran intuiciones sobre el impacto que tiene en la performance de los modelos el hecho de que el mismo árbol maneje los valores faltantes (NAs). Esta característica está implementada en R, específicamente en la librería **rpart**, pero no está disponible en las implementaciones populares de Python.

El trabajo práctico consiste en generar un archivo R Markdown (.Rmd) que incluya todo el código, análisi s yexplicaciones hechas por ustedes. A continuación, se detalla la estructura que debe tener este archivo.

## 1. Introducción al problema

El conjunto de datos contiene información sobre características demográficas y biométricas de individuos, con el objetivo de predecir si una persona consume alcohol o no. La variable objetivo es DRK_YN, que indica si la persona consume alcohol (Yes) o no (No). Esta fue descargada de [kaggle](https://www.kaggle.com/datasets/sooyoungher/smoking-drinking-dataset)

# Variables Principales:

-   **sex**: Género de la persona (Male/Female).
-   **age**: Edad de la persona.
-   **height**: Altura de la persona en centímetros.
-   **weight**: Peso de la persona en kilogramos.
-   **waistline**: Circunferencia de la cintura en centímetros.
-   **sight_left / sight_right**: Agudeza visual en el ojo izquierdo/derecho.
-   **hear_left / hear_right**: Capacidad auditiva en el oído izquierdo/derecho.
-   **SBP**: Presión arterial sistólica.
-   **LDL_chole**: Niveles de colesterol LDL.
-   **triglyceride**: Niveles de triglicéridos.
-   **hemoglobin**: Niveles de hemoglobina.
-   **urine_protein**: Presencia de proteínas en la orina.
-   **serum_creatinine**: Niveles de creatinina en suero.
-   **SGOT_AST / SGOT_ALT**: Enzimas hepáticas.
-   **gamma_GTP**: Enzima hepática relacionada con el consumo de alcohol.
-   **SMK_stat_type_cd**: Código de estado de fumador.
-   **DRK_YN**: Variable objetivo que indica si la persona consume alcohol o no (Yes/No).

# Problema a Resolver:

El objetivo es desarrollar un modelo predictivo que, basado en las características biométricas y demográficas, determine si una persona es consumidora de alcohol o no.

# Por qué esta elección

El conjunto de datos es ideal para el uso de árboles de decisión debido a la combinación de variables numéricas y categóricas, lo que permite capturar interacciones complejas entre características biométricas y de salud sin necesidad de preprocesamiento extenso. Además, los árboles de decisión ofrecen transparencia e interpretabilidad, lo que es crucial en contextos de salud. También manejan de manera efectiva datos faltantes y son robustos frente a outliers, lo que los hace flexibles y adecuados para la clasificación binaria, como en este caso, donde se busca predecir el consumo de alcohol. (CAMBIAR)

## 2. Preparación de los datos

```{r pressure, echo=FALSE}

# Cargamos los datos
#fumadores = read.csv("data/smoking_driking_dataset_Ver01.csv", header = TRUE, sep = ",")
fumadores_50 <- read.csv("data/reducido.csv", header = TRUE, sep = ",")

# Verificar el número de observaciones y predictores
#num_observaciones <- nrow(fumadores)
#num_predictores <- ncol(fumadores)

num_observaciones <- nrow(fumadores_50)
num_predictores <- ncol(fumadores_50)

cat("Número de observaciones:", num_observaciones, "\n")
cat("Número de predictores:", num_predictores, "\n")
```

# Modificamos el data frame para poder trabajar con los datos de forma correcta y como especifica el enunciado

```{r pressure, echo=FALSE}
# Achicamos la informacion en terminos de observaciones
set.seed(44512364)
# fumadores_50 <- fumadores[sample(nrow(fumadores), 50000), ]
# write.csv(fumadores_50, "data/reducido.csv", row.names = FALSE)

# Modificamos las variables categoricas de numeros a palabras:

# Modificar la variable 'hear_left'
fumadores_50$hear_left <- factor(fumadores_50$hear_left,
                                 levels = c(1.0, 2.0),
                                 labels = c("normal", "abnormal"))

# Modificar la variable 'hear_right'
fumadores_50$hear_right <- factor(fumadores_50$hear_right,
                                  levels = c(1.0, 2.0),
                                  labels = c("normal", "abnormal"))

# Modificar la variable 'SMK_stat_type_cd'
fumadores_50$SMK_stat_type_cd <- factor(fumadores_50$SMK_stat_type_cd,
                                        levels = c(1.0, 2.0, 3.0),
                                        labels = c("never", "used to smoke but quit", "still smoke"))

# Modificar la variable 'urine_protein'
fumadores_50$urine_protein <- factor(fumadores_50$urine_protein,
                                     levels = c(1, 2, 3, 4, 5, 6),
                                     labels = c("Negativo (-)", "Trazas (+/-)", "Bajo (+1)", 
                                                "Moderado (+2)", "Alto (+3)", "Muy alto (+4)"))

# Modificar la variable 'DRK_YN'
fumadores_50$DRK_YN <- as.factor(fumadores_50$DRK_YN)

```

# Obtener estadísticas descriptivas de las variables principales

```{r pressure, echo=FALSE}
# Definir el vector con los nombres de las variables principales
variables <- c("age", "height", "weight", "waistline", "SBP", "LDL_chole", "triglyceride", "hemoglobin")

# Seleccionar las variables principales
variables_principales <- fumadores_50[, variables]

# Mostrar la estructura de las variables seleccionadas
str(variables_principales)
```
# Construcción de un árbol de decisión básico 
```{r pressure, echo=FALSE}

n <- nrow(fumadores_50)

n_train <- floor(0.70 * n)
n_val <- floor(0.15 * n)
n_test <- n - n_train - n_val

indices <- sample(1:n)

train_indices <- indices[1:n_train]
val_indices <- indices[(n_train + 1):(n_train + n_val)]
test_indices <- indices[(n_train + n_val + 1):n]

train_data <- fumadores_50[train_indices, ]
val_data <- fumadores_50[val_indices, ]
test_data <- fumadores_50[test_indices, ]

# Arbol
# control_params <- rpart.control(minsplit = 20, minbucket = round(20/3), cp = 0.001, xval = 10, maxdepth = 30)

arbol <- rpart(formula = DRK_YN ~ age + height + weight + waistline + SBP + LDL_chole + triglyceride + hemoglobin + urine_protein,
               data = train_data, method = "class", control = control_params)

rpart.plot(arbol)
```
# Interpretación del arbol obtenido 
- Podemos visualizar que


# Evaluacion del árbol de decision básico

## Predicciones
```{r pressure, echo=FALSE}
# Predecir las probabilidades
pred_prob <- predict(arbol, newdata = test_data, type = "prob")

# Predecir las clases
pred_class <- predict(arbol, newdata = test_data, type = "class")

head(pred_prob)
head(pred_class)
```
## Metricas de performance
### Matriz de confusion
```{r pressure, echo=FALSE}
# Calcular la matriz de confusión
matriz_confusion <- table(Predicted = pred_class, Actual = test_data$DRK_YN)

print(matriz_confusion)
```
### Accuracy
```{r pressure, echo=FALSE}
accuracy <- sum(diag(matriz_confusion)) / sum(matriz_confusion)
cat("Accuracy: ", accuracy, "\n")
```

### Precision y Recall
```{r pressure, echo=FALSE}
precision <- matriz_confusion["Y", "Y"] / (matriz_confusion["Y", "Y"] + matriz_confusion["Y", "N"])

recall <- matriz_confusion["Y", "Y"] / (matriz_confusion["Y", "Y"] + matriz_confusion["N", "Y"])

cat("Precision: ", precision, "\n")
cat("Recall: ", recall, "\n")
```

### F1-Score
```{r pressure, echo=FALSE}
f1_score <- 2 * ((precision * recall) / (precision + recall))

cat("F1-Score: ", f1_score, "\n")

```

### AUC-ROC
```{r pressure, echo=FALSE}
roc_curve <- roc(test_data$DRK_YN, pred_prob[, "Y"], levels = rev(levels(test_data$DRK_YN)))

plot(roc_curve, col = "blue", main = "ROC Curve")

# Calcular el valor AUC
auc_value <- auc(roc_curve)
cat("AUC-ROC: ", auc_value, "\n")

```

# Oprimizacion del modelo
```{r pressure, echo=FALS